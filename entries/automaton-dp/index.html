<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
    <title>オートマトン上の DP (桁 DP の一般化) - kuretchi's blog</title>
    <meta property="og:url" content="/blog/entries/automaton-dp/index.html" />
    <meta property="og:title" content="オートマトン上の DP (桁 DP の一般化) - kuretchi's blog" />
    <meta name="twitter:card" content="summary" />
    <style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */
    </style>
    <link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css" />
    <link rel="stylesheet" href="/blog/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" type="text/javascript"></script>
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div id="global-container">
      <header id="global-header">
        <div id="global-header-container">
          <a id="blog-title" href="/blog/">kuretchi's blog</a>
        </div>
      </header>
      <article id="content">
        <header class="entry-header">
          <h1 class="entry-title">オートマトン上の DP (桁 DP の一般化)</h1>
            <time class="entry-date" datetime="2020-07-10">2020-07-10</time>
          </header>
        <div id="body-container">
<p>桁 DP で解くことのできる多くの問題は，「条件○○を満たすすべての非負整数について，それぞれに○○を適用し，それらの和を求めよ」のような形式であり，多くの場合「条件○○」は「あるオートマトンが受理する」と言い換えることができます．その視点においては，桁 DP とはすなわちオートマトン上の DP である，ということになり，あらゆるオートマトンで動作する一般的なアルゴリズムが得られます．</p>
<h2 id="できること">できること</h2>
<p>ざっくりと：「オートマトン <span class="math inline">\(A\)</span> が与えられる．<span class="math inline">\(A\)</span> が受理するすべての長さ <span class="math inline">\(n\)</span> の文字列に対して，適当な <span class="math inline">\(f\)</span> をそれぞれに適用したのち，それらの和を求めよ」</p>
<p>正確に：次の問題を，時間計算量 <span class="math inline">\(O(n \cdot \vert Q \vert \cdot \vert \Sigma \vert)\)</span>，空間計算量 <span class="math inline">\(O(n \cdot \vert Q \vert)\)</span> または <span class="math inline">\(O(\vert Q \vert)\)</span> で解きます．</p>
<p>入力：</p>
<ul>
<li>決定性有限オートマトン (DFA) <span class="math inline">\(A = \langle Q, \Sigma, \delta, q _ \text{init}, F \rangle\)</span></li>
<li><span class="math inline">\(n \in \mathbb{N}\)</span></li>
<li>可換モノイド <span class="math inline">\(\langle M, \oplus \rangle\)</span> (単位元を <span class="math inline">\(0 _ M\)</span> とします)</li>
<li><span class="math inline">\(e \in M\)</span><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li><span class="math inline">\(\odot : M \times \Sigma \rightarrow M\)</span>
<ul>
<li>ただし，分配法則：<span class="math inline">\(\forall x, y \in M \, \forall c \in \Sigma \, \lbrack (x \oplus y) \odot c = (x \odot c) \oplus (y \odot c) \rbrack\)</span> を満たす．</li>
</ul></li>
</ul>
<p>出力：<span class="math inline">\(\bigoplus _ {s \in \mathrm{L}(A) \cap \Sigma^n} f(s)\)</span></p>
<p>ただし，<span class="math inline">\(\mathrm{L}(A)\)</span> を <span class="math inline">\(A\)</span> が受理する文字列の全体とし，<span class="math inline">\(f(s) = (((e \odot s _ 1) \odot s _ 2) \dots) \odot s _ {\vert s \vert}\)</span> としました (<span class="math inline">\(s _ i\)</span> は <span class="math inline">\(s\)</span> の <span class="math inline">\(i\)</span> 番目の文字，<span class="math inline">\(\vert s \vert\)</span> は <span class="math inline">\(s\)</span> の長さ)．</p>
<p><span class="math inline">\(\epsilon\)</span> を空文字列とし，以降，<span class="math inline">\(e\)</span> のことを <span class="math inline">\(f(\epsilon)\)</span> と書くことがあります．</p>
<h2 id="理論">理論</h2>
<h3 id="ボトムアップ的な手法-配る-dp">ボトムアップ的な手法 (配る DP)</h3>
<p><span class="math inline">\(dp(i, q)\)</span> を，「<span class="math inline">\(A\)</span> に与えたとき最終的な遷移先が <span class="math inline">\(q\)</span> であるような長さ <span class="math inline">\(i\)</span> の文字列すべてに <span class="math inline">\(f\)</span> を適用し，<span class="math inline">\(\oplus\)</span> で <a href="https://ja.wikipedia.org/w/index.php?title=%E9%AB%98%E9%9A%8E%E9%96%A2%E6%95%B0&amp;oldid=78331470#fold">fold</a> した結果」とする気持ちで，次のように定義します．</p>
<p><span class="math display">\[
  \begin{align}
    dp(0, q) &amp;= \begin{cases}
      0 _ M &amp; (q \ne q _ \text{init}) \newline
      f(\epsilon) &amp; (q = q _ \text{init})
    \end{cases} \newline
    dp(i, q) &amp;= \bigoplus _ {\delta(p, c) = q} (dp(i - 1, p) \odot c) &amp; (i \gt 0)
  \end{align}
\]</span></p>
<p><span class="math inline">\(\bigoplus _ {q \in F} dp(n, q)\)</span> が求める答えです．これを DP で求めることで解けました．</p>
<p>証明：TODO</p>
<p>擬似コード：</p>
<ol type="1">
<li><span class="math inline">\(\hspace{0em} \texttt{procedure}\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{for}\ i = 0\ \texttt{to}\ n\)</span></li>
<li><span class="math inline">\(\hspace{2em} \texttt{foreach}\ q \in Q\)</span></li>
<li><span class="math inline">\(\hspace{3em} \mathit{dp}\lbrack i \rbrack\lbrack q \rbrack \gets \texttt{if}\ i = 0 \land q = q _ \text{init}\ \texttt{then}\ f(\epsilon)\ \texttt{else}\ 0 _ M\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{for}\ i = 1\ \texttt{to}\ n\)</span></li>
<li><span class="math inline">\(\hspace{2em} \texttt{foreach}\ p \in Q\)</span></li>
<li><span class="math inline">\(\hspace{3em}\texttt{foreach}\ c \in \Sigma\)</span></li>
<li><span class="math inline">\(\hspace{4em} q \gets \delta(p, c)\)</span></li>
<li><span class="math inline">\(\hspace{4em} \mathit{dp}\lbrack i \rbrack\lbrack q \rbrack \gets \mathit{dp}\lbrack i \rbrack\lbrack q \rbrack \oplus (\mathit{dp}\lbrack i - 1 \rbrack\lbrack p \rbrack \odot c)\)</span></li>
<li><span class="math inline">\(\hspace{1em} \mathit{acc} \gets 0 _ M\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{foreach}\ q \in F\)</span></li>
<li><span class="math inline">\(\hspace{2em} \mathit{acc} \gets \mathit{acc} \oplus \mathit{dp}\lbrack n \rbrack\lbrack q \rbrack\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{return}\ \mathit{acc}\)</span></li>
</ol>
<h3 id="トップダウン的な手法-貰う-dp-メモ化再帰">トップダウン的な手法 (貰う DP / メモ化再帰)</h3>
<p>ここでのみ，<span class="math inline">\(f(s) = (((e \odot s _ {\vert s \vert}) \odot s _ {\vert s \vert - 1}) \dots) \odot s _ 1\)</span> とします．</p>
<p><span class="math inline">\(dp(i, q)\)</span> を，「状態 <span class="math inline">\(q\)</span> の <span class="math inline">\(A\)</span> に与えたとき最終的な遷移先が受理状態であるような長さ <span class="math inline">\(i\)</span> の文字列すべてに <span class="math inline">\(f\)</span> を適用し，<span class="math inline">\(\oplus\)</span> で fold した結果」とする気持ちで，次のように定義します．</p>
<p><span class="math display">\[
  \begin{align}
    dp(0, q) &amp;= \begin{cases}
      0 _ M &amp; (q \notin F) \newline
      f(\epsilon) &amp; (q \in F)
    \end{cases} \newline
    dp(i, q) &amp;= \bigoplus _ {c \in \Sigma} (dp(i - 1, \delta(q, c)) \odot c) &amp; (i \gt 0)
  \end{align}
\]</span></p>
<p><span class="math inline">\(\mathit{dp}(n, q _ \text{init})\)</span> が求める答えです．これを DP で求めることで解けました．</p>
<p>証明：TODO</p>
<p>擬似コード：</p>
<ol type="1">
<li><span class="math inline">\(\hspace{0em} \texttt{procedure}\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{foreach}\ q \in Q\)</span></li>
<li><span class="math inline">\(\hspace{2em} \mathit{dp}\lbrack 0 \rbrack \lbrack q \rbrack \gets \texttt{if}\ q \notin F\ \texttt{then}\ 0 _ M\ \texttt{else}\ f(\epsilon)\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{for}\ i = 1\ \texttt{to}\ n\)</span></li>
<li><span class="math inline">\(\hspace{2em} \texttt{foreach}\ q \in Q\)</span></li>
<li><span class="math inline">\(\hspace{3em} \mathit{dp}\lbrack i \rbrack\lbrack q \rbrack \gets 0 _ M\)</span></li>
<li><span class="math inline">\(\hspace{3em} \texttt{foreach}\ c \in \Sigma\)</span></li>
<li><span class="math inline">\(\hspace{4em} \mathit{dp}\lbrack i \rbrack \lbrack q \rbrack \gets \mathit{dp}\lbrack i \rbrack \lbrack q \rbrack \oplus \mathit{dp}\lbrack i - 1 \rbrack \lbrack \delta(q, c) \rbrack \odot c\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{return}\ \mathit{dp}\lbrack n \rbrack \lbrack q _ \text{init} \rbrack\)</span></li>
</ol>
<p>または</p>
<ol type="1">
<li><span class="math inline">\(\hspace{0em} \texttt{function}\ \mathit{dp}(i, q)\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{if}\ i = 0\ \texttt{then}\)</span></li>
<li><span class="math inline">\(\hspace{2em} \texttt{return}\ \texttt{if}\ q \notin F\ \texttt{then}\ 0 _ M\ \texttt{else}\ f(\epsilon)\)</span></li>
<li><span class="math inline">\(\hspace{1em} \mathit{acc} \gets 0 _ M\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{foreach}\ c \in \Sigma\)</span></li>
<li><span class="math inline">\(\hspace{2em} \mathit{acc} \gets \mathit{acc} \oplus (\mathit{dp}(i - 1, \delta(q, c)) \odot c)\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{return}\ \mathit{acc}\)</span></li>
<li><span class="math inline">\(\hspace{0em} \texttt{procedure}\)</span></li>
<li><span class="math inline">\(\hspace{1em} \texttt{return}\ \mathit{dp}(n, q _ \text{init})\)</span></li>
</ol>
<p>ただし関数 <span class="math inline">\(\mathit{dp}\)</span> はメモ化すること．</p>
<h2 id="実践">実践</h2>
<p>次の問題を，上の「ボトムアップ的な手法」で解いてみましょう．</p>
<blockquote>
<p>正整数であって，その <span class="math inline">\(10\)</span> 進表記において桁の数字が増加と減少を交互に繰り返すようなものをジグザグ数とよぶ． <span class="math inline">\(x\)</span> 以下かつ <span class="math inline">\(m\)</span> の倍数であるようなすべてのジグザグ数の<strong>総和</strong>を <span class="math inline">\(10^9 + 7\)</span> で割った余りを求めよ．</p>
<ul>
<li><span class="math inline">\(1 \le x \le 10^{500}\)</span></li>
<li><span class="math inline">\(1 \le m \le 500\)</span></li>
</ul>
<p><cite><a href="https://onlinejudge.u-aizu.ac.jp/problems/0570">ジグザグ数 (Zig-Zag Numbers)</a> 改題 </cite></p>
</blockquote>
<p><span class="math inline">\(x\)</span> の <span class="math inline">\(10\)</span> 進表記の桁数を <span class="math inline">\(n\)</span> とします．<span class="math inline">\(x\)</span> 以下の正整数は，leading zero を適当な個数加えることで，文字集合 <span class="math inline">\(\Sigma = \lbrace 0, 1, \dots, 9 \rbrace\)</span> 上の長さ <span class="math inline">\(n\)</span> の文字列と見ることができます．</p>
<p>「<span class="math inline">\(x\)</span> 以下 かつ <span class="math inline">\(m\)</span> の倍数であるようなジグザグ数」のみを受理する DFA を <span class="math inline">\(A\)</span> としましょう．まずは次の三つの DFA <span class="math inline">\(A _ 1, A _ 2, A _ 3\)</span> を考えます．</p>
<ul>
<li><span class="math inline">\(x\)</span> 以下の正整数のみを受理する DFA <span class="math inline">\(A _ 1 = \langle Q _ 1, \Sigma, \delta _ 1, {q _ \text{init}} _ 1, F _ 1 \rangle\)</span>
<ul>
<li><span class="math inline">\(Q _ 1 = \lbrace \mathtt{tight}, \mathtt{loose}, \mathtt{exceeded} \rbrace \times \lbrack n \rbrack\)</span><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> <!-- * 最上位からある桁まで見たときに，
    * $\texttt{tight}$：$x$ との大小関係が未確定．
    * $\texttt{loose}$：$x$ 未満であることが確定している．
    * $\texttt{exceeded}$：$x$ を超えることが確定している．
  * $\lbrack n \rbrack$ は今見ているのが何桁目かを表す． --></li>
<li><span class="math inline">\(i &lt; n\)</span> のとき，
<ul>
<li><span class="math inline">\(\delta _ 1(\langle \mathtt{tight}, i \rangle, c) = \begin{cases} \langle \mathtt{loose}, i + 1 \rangle &amp; (c &lt; x _ {i + 1}) \newline \langle \mathtt{tight}, i + 1 \rangle &amp; (c = x _ {i + 1}) \newline \langle \mathtt{exceeded}, i + 1 \rangle &amp; (c &gt; x _ {i + 1}) \end{cases}\)</span></li>
<li><span class="math inline">\(\delta _ 1(\langle \mathtt{loose}, i \rangle, c) = \langle \mathtt{loose}, i + 1 \rangle\)</span></li>
<li><span class="math inline">\(\delta _ 1(\langle \mathtt{exceeded}, i \rangle, c) = \langle \mathtt{exceeded}, i + 1 \rangle\)</span></li>
</ul></li>
<li><span class="math inline">\(\delta _ 1(\langle q, n \rangle, c) = \langle \texttt{exceeded}, n \rangle\)</span></li>
<li><span class="math inline">\({q _ \text{init}} _ 1 = \langle \mathtt{tight}, 0 \rangle\)</span></li>
<li><span class="math inline">\(F _ 1 = \lbrace \mathtt{tight}, \mathtt{loose} \rbrace \times \lbrack n \rbrack\)</span></li>
</ul></li>
<li><span class="math inline">\(m\)</span> の倍数のみを受理する DFA <span class="math inline">\(A _ 2 = \langle Q _ 2, \Sigma, \delta _ 2, {q _ \text{init}} _ 2, F _ 2 \rangle\)</span>
<ul>
<li><span class="math inline">\(Q _ 2 = \lbrack m - 1 \rbrack\)</span></li>
<li><span class="math inline">\(\delta _ 2(q, c) = (10q + c) \bmod m\)</span></li>
<li><span class="math inline">\({q _ \text{init}} _ 2 = 0\)</span></li>
<li><span class="math inline">\(F _ 2 = \lbrace 0 \rbrace\)</span></li>
</ul></li>
<li>ジグザグ数のみを受理する DFA <span class="math inline">\(A _ 3 = \langle Q _ 3, \Sigma, \delta _ 3, {q _ \text{init}} _ 3, F _ 3 \rangle\)</span>
<ul>
<li><span class="math inline">\(Q _ 3 = \lbrace \mathtt{empty}, \mathtt{rejected} \rbrace \cup (\lbrace \mathtt{single}, \mathtt{increasing}, \mathtt{decreasing} \rbrace \times \Sigma)\)</span> <!-- * 最上位からある桁まで見たときに，
    * $\texttt{empty}$：一桁も見ていないか，見たすべての桁が $0$ (leading zero)．
    * $\texttt{single}$：一桁しか見ていない．
    * $\texttt{increasing}$：ジグザグ数の可能性があり，一つ上の桁は二つ上の桁より大きい．
    * $\texttt{decreasing}$：ジグザグ数の可能性があり，一つ上の桁は二つ上の桁より小さい．
    * $\texttt{rejected}$：ジグザグ数ではないことが確定している．
  * $\Sigma$ は一つ上の桁を表す． --></li>
<li><span class="math inline">\(\delta _ 3(\mathtt{empty}, c) = \begin{cases} \mathtt{empty} &amp; (c = 0) \newline \langle \mathtt{single}, c \rangle &amp; (c \neq 0) \end{cases}\)</span></li>
<li><span class="math inline">\(\delta _ 3(\langle \mathtt{single}, c _ \text{prev} \rangle, c) = \begin{cases} \langle \mathtt{increasing}, c \rangle &amp; (c _ \text{prev} \lt c) \newline \mathtt{rejected} &amp; (c _ \text{prev} = c) \newline \langle \mathtt{decreasing}, c \rangle &amp; (c _ \text{prev} \gt c) \end{cases}\)</span></li>
<li><span class="math inline">\(\delta _ 3(\langle \mathtt{increasing}, c _ \text{prev} \rangle, c) = \begin{cases} \mathtt{rejected} &amp; (c _ \text{prev} \le c) \newline \langle \mathtt{decreasing}, c \rangle &amp; (c _ \text{prev} \gt c) \end{cases}\)</span></li>
<li><span class="math inline">\(\delta _ 3(\langle \mathtt{decreasing}, c _ \text{prev} \rangle, c) = \begin{cases} \langle \mathtt{increasing}, c \rangle &amp; (c _ \text{prev} \lt c) \newline \mathtt{rejected} &amp; (c _ \text{prev} \ge c) \end{cases}\)</span></li>
<li><span class="math inline">\(\delta _ 3(\mathtt{rejected}, c) = \mathtt{rejected}\)</span></li>
<li><span class="math inline">\({q _ \text{init}} _ 3 = \mathtt{empty}\)</span></li>
<li><span class="math inline">\(F _ 3 = Q _ 3 \setminus \lbrace \mathtt{empty}, \mathtt{rejected} \rbrace\)</span></li>
</ul></li>
</ul>
<p>ただし，タイプライタ体で書いたものはすべて相異なる定数，<span class="math inline">\(x _ i\)</span> は <span class="math inline">\(x\)</span> の上から <span class="math inline">\(i\)</span> 桁目，<span class="math inline">\(n \in \mathbb{N}\)</span> について <span class="math inline">\(\lbrack n \rbrack = \lbrace 0, 1, \dots, n \rbrace\)</span> とします．</p>
<p>すると，<span class="math inline">\(A = \langle Q, \Sigma, \delta, q _ \text{init}, F \rangle\)</span> は次のように <span class="math inline">\(A _ 1, A _ 2, A _ 3\)</span> の intersection として書くことができます．</p>
<ul>
<li><span class="math inline">\(Q = Q _ 1 \times Q _ 2 \times Q _ 3\)</span></li>
<li><span class="math inline">\(\delta(\langle q _ 1, q _ 2, q _ 3 \rangle, c) = \langle \delta _ 1(q _ 1, c), \delta _ 2(q _ 2, c), \delta _ 3(q _ 3, c) \rangle\)</span></li>
<li><span class="math inline">\(q _ \text{init} = \langle {q _ \text{init}} _ 1, {q _ \text{init}} _ 2, {q _ \text{init}} _ 3 \rangle\)</span></li>
<li><span class="math inline">\(F = F _ 1 \times F _ 2 \times F _ 3\)</span></li>
</ul>
<p>あとは，<span class="math inline">\(f(s)\)</span> が文字列 <span class="math inline">\(s\)</span> の正整数としての値を返すようにして，<span class="math inline">\(\oplus\)</span> でそれらの和を取る気持ちでいきますが，そのままだと分配法則を満たさないため次のように工夫<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>をします．</p>
<ul>
<li><span class="math inline">\(M = \mathbb{Z}/(10^9 + 7)\mathbb{Z} \times \mathbb{N}\)</span></li>
<li><span class="math inline">\(\langle x, n \rangle \oplus \langle y, m \rangle = \langle x + y, n + m \rangle\)</span></li>
<li><span class="math inline">\(e = \langle 0, 1 \rangle\)</span></li>
<li><span class="math inline">\(\langle x, n \rangle \odot c = \langle 10 x + c n, n \rangle\)</span></li>
</ul>
<p>これが分配法則を満たすことは簡単に確かめられます．以上で解けました．</p>
<p>実装 (Rust)：</p>
<p>今回は紹介しなかった，エラー状態を利用した枝刈りなどが入っています．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">use</span> <span class="pp">std::</span><span class="op">{</span><span class="pp">cmp::Ordering::</span><span class="op">*,</span> <span class="pp">collections::</span>HashMap<span class="op">,</span> <span class="pp">hash::</span><span class="bu">Hash</span><span class="op">,</span> mem<span class="op">};</span></span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">trait</span> Monoid <span class="op">{</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="kw">fn</span> op(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> rhs<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="kw">fn</span> identity() <span class="op">-&gt;</span> <span class="dt">Self</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">// モノイドの直積</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="kw">impl</span><span class="op">&lt;</span>T0<span class="op">:</span> Monoid<span class="op">,</span> T1<span class="op">:</span> Monoid<span class="op">&gt;</span> Monoid <span class="kw">for</span> (T0<span class="op">,</span> T1) <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="kw">fn</span> op(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> rhs<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>    (<span class="kw">self</span><span class="op">.</span><span class="dv">0</span><span class="op">.</span>op(<span class="op">&amp;</span>rhs<span class="op">.</span><span class="dv">0</span>)<span class="op">,</span> <span class="kw">self</span><span class="op">.</span><span class="dv">1</span><span class="op">.</span>op(<span class="op">&amp;</span>rhs<span class="op">.</span><span class="dv">1</span>))</span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="op">}</span></span>
<span id="cb1-13"><a href="#cb1-13"></a></span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="kw">fn</span> identity() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    (<span class="pp">T0::</span>identity()<span class="op">,</span> <span class="pp">T1::</span>identity())</span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="op">}</span></span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="kw">const</span> MOD<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">1_000_000_007</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20"></a></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">// モノイド (ℤ/(10^9 + 7)ℤ, +)</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="at">)]</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="kw">struct</span> ModSum(<span class="dt">u64</span>)<span class="op">;</span></span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="kw">impl</span> Monoid <span class="kw">for</span> ModSum <span class="op">{</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="kw">fn</span> op(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> rhs<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>    ModSum((<span class="kw">self</span><span class="op">.</span><span class="dv">0</span> <span class="op">+</span> rhs<span class="op">.</span><span class="dv">0</span>) <span class="op">%</span> MOD)</span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="op">}</span></span>
<span id="cb1-29"><a href="#cb1-29"></a></span>
<span id="cb1-30"><a href="#cb1-30"></a>  <span class="kw">fn</span> identity() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>    ModSum(<span class="dv">0</span>)</span>
<span id="cb1-32"><a href="#cb1-32"></a>  <span class="op">}</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="op">}</span></span>
<span id="cb1-34"><a href="#cb1-34"></a></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="kw">trait</span> Dfa <span class="op">{</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="kw">type</span> Char<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="kw">type</span> State<span class="op">;</span></span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="kw">fn</span> initial_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;;</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="kw">fn</span> next_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">,</span> c<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Char) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;;</span></span>
<span id="cb1-41"><a href="#cb1-41"></a>  <span class="kw">fn</span> is_accept_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State) <span class="op">-&gt;</span> <span class="dt">bool</span><span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42"></a><span class="op">}</span></span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="kw">fn</span> automaton_dp<span class="op">&lt;</span>A<span class="op">,</span> M<span class="op">&gt;</span>(</span>
<span id="cb1-45"><a href="#cb1-45"></a>  dfa<span class="op">:</span> A<span class="op">,</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  sigma<span class="op">:</span> <span class="kw">impl</span> <span class="bu">Iterator</span><span class="op">&lt;</span>Item <span class="op">=</span> <span class="pp">A::</span>Char<span class="op">&gt;</span> <span class="op">+</span> <span class="bu">Clone</span><span class="op">,</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>  len<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>  <span class="kw">mut</span> mul<span class="op">:</span> <span class="kw">impl</span> <span class="bu">FnMut</span>(<span class="op">&amp;</span>M<span class="op">,</span> <span class="op">&amp;</span><span class="pp">A::</span>Char) <span class="op">-&gt;</span> M<span class="op">,</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>  e<span class="op">:</span> M<span class="op">,</span></span>
<span id="cb1-50"><a href="#cb1-50"></a>) <span class="op">-&gt;</span> M</span>
<span id="cb1-51"><a href="#cb1-51"></a><span class="kw">where</span></span>
<span id="cb1-52"><a href="#cb1-52"></a>  A<span class="op">:</span> Dfa<span class="op">,</span></span>
<span id="cb1-53"><a href="#cb1-53"></a>  <span class="pp">A::</span>State<span class="op">:</span> <span class="bu">Eq</span> <span class="op">+</span> <span class="bu">Hash</span><span class="op">,</span></span>
<span id="cb1-54"><a href="#cb1-54"></a>  M<span class="op">:</span> Monoid<span class="op">,</span></span>
<span id="cb1-55"><a href="#cb1-55"></a><span class="op">{</span></span>
<span id="cb1-56"><a href="#cb1-56"></a>  <span class="kw">let</span> <span class="kw">mut</span> dp <span class="op">=</span> <span class="pp">HashMap::</span><span class="op">&lt;</span><span class="pp">A::</span>State<span class="op">,</span> M<span class="op">&gt;</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="kw">let</span> <span class="kw">mut</span> dp_next <span class="op">=</span> <span class="pp">HashMap::</span><span class="op">&lt;</span><span class="pp">A::</span>State<span class="op">,</span> M<span class="op">&gt;</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb1-58"><a href="#cb1-58"></a></span>
<span id="cb1-59"><a href="#cb1-59"></a>  <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(initial_state) <span class="op">=</span> dfa<span class="op">.</span>initial_state() <span class="op">{</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>    dp<span class="op">.</span>insert(initial_state<span class="op">,</span> e)<span class="op">;</span></span>
<span id="cb1-61"><a href="#cb1-61"></a>  <span class="op">}</span></span>
<span id="cb1-62"><a href="#cb1-62"></a>  <span class="kw">for</span> _ <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>len <span class="op">{</span></span>
<span id="cb1-63"><a href="#cb1-63"></a>    <span class="kw">for</span> (state<span class="op">,</span> value) <span class="kw">in</span> dp<span class="op">.</span>drain() <span class="op">{</span></span>
<span id="cb1-64"><a href="#cb1-64"></a>      <span class="kw">for</span> c <span class="kw">in</span> sigma<span class="op">.</span>clone() <span class="op">{</span></span>
<span id="cb1-65"><a href="#cb1-65"></a>        <span class="kw">if</span> <span class="kw">let</span> <span class="cn">Some</span>(next_state) <span class="op">=</span> dfa<span class="op">.</span>next_state(<span class="op">&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>c) <span class="op">{</span></span>
<span id="cb1-66"><a href="#cb1-66"></a>          <span class="kw">let</span> value <span class="op">=</span> mul(<span class="op">&amp;</span>value<span class="op">,</span> <span class="op">&amp;</span>c)<span class="op">;</span></span>
<span id="cb1-67"><a href="#cb1-67"></a>          dp_next</span>
<span id="cb1-68"><a href="#cb1-68"></a>            <span class="op">.</span>entry(next_state)</span>
<span id="cb1-69"><a href="#cb1-69"></a>            <span class="op">.</span>and_modify(<span class="op">|</span>acc<span class="op">|</span> <span class="op">*</span>acc <span class="op">=</span> acc<span class="op">.</span>op(<span class="op">&amp;</span>value))</span>
<span id="cb1-70"><a href="#cb1-70"></a>            <span class="op">.</span>or_insert(value)<span class="op">;</span></span>
<span id="cb1-71"><a href="#cb1-71"></a>        <span class="op">}</span></span>
<span id="cb1-72"><a href="#cb1-72"></a>      <span class="op">}</span></span>
<span id="cb1-73"><a href="#cb1-73"></a>    <span class="op">}</span></span>
<span id="cb1-74"><a href="#cb1-74"></a>    <span class="pp">mem::</span>swap(<span class="op">&amp;</span><span class="kw">mut</span> dp<span class="op">,</span> <span class="op">&amp;</span><span class="kw">mut</span> dp_next)<span class="op">;</span></span>
<span id="cb1-75"><a href="#cb1-75"></a>    dp_next<span class="op">.</span>clear()<span class="op">;</span></span>
<span id="cb1-76"><a href="#cb1-76"></a>  <span class="op">}</span></span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a>  <span class="kw">let</span> <span class="kw">mut</span> acc <span class="op">=</span> <span class="pp">M::</span>identity()<span class="op">;</span></span>
<span id="cb1-79"><a href="#cb1-79"></a>  <span class="kw">for</span> (state<span class="op">,</span> value) <span class="kw">in</span> dp <span class="op">{</span></span>
<span id="cb1-80"><a href="#cb1-80"></a>    <span class="kw">if</span> dfa<span class="op">.</span>is_accept_state(<span class="op">&amp;</span>state) <span class="op">{</span></span>
<span id="cb1-81"><a href="#cb1-81"></a>      acc <span class="op">=</span> acc<span class="op">.</span>op(<span class="op">&amp;</span>value)<span class="op">;</span></span>
<span id="cb1-82"><a href="#cb1-82"></a>    <span class="op">}</span></span>
<span id="cb1-83"><a href="#cb1-83"></a>  <span class="op">}</span></span>
<span id="cb1-84"><a href="#cb1-84"></a>  acc</span>
<span id="cb1-85"><a href="#cb1-85"></a><span class="op">}</span></span>
<span id="cb1-86"><a href="#cb1-86"></a></span>
<span id="cb1-87"><a href="#cb1-87"></a><span class="co">// DFA の intersection</span></span>
<span id="cb1-88"><a href="#cb1-88"></a><span class="kw">struct</span> And<span class="op">&lt;</span>A0<span class="op">,</span> A1<span class="op">&gt;</span>(A0<span class="op">,</span> A1)<span class="op">;</span></span>
<span id="cb1-89"><a href="#cb1-89"></a></span>
<span id="cb1-90"><a href="#cb1-90"></a><span class="kw">impl</span><span class="op">&lt;</span>A0<span class="op">,</span> A1<span class="op">&gt;</span> Dfa <span class="kw">for</span> And<span class="op">&lt;</span>A0<span class="op">,</span> A1<span class="op">&gt;</span></span>
<span id="cb1-91"><a href="#cb1-91"></a><span class="kw">where</span></span>
<span id="cb1-92"><a href="#cb1-92"></a>  A0<span class="op">:</span> Dfa<span class="op">,</span></span>
<span id="cb1-93"><a href="#cb1-93"></a>  A1<span class="op">:</span> Dfa<span class="op">&lt;</span>Char <span class="op">=</span> <span class="pp">A0::</span>Char<span class="op">&gt;,</span></span>
<span id="cb1-94"><a href="#cb1-94"></a><span class="op">{</span></span>
<span id="cb1-95"><a href="#cb1-95"></a>  <span class="kw">type</span> Char <span class="op">=</span> <span class="pp">A0::</span>Char<span class="op">;</span></span>
<span id="cb1-96"><a href="#cb1-96"></a>  <span class="kw">type</span> State <span class="op">=</span> (<span class="pp">A0::</span>State<span class="op">,</span> <span class="pp">A1::</span>State)<span class="op">;</span></span>
<span id="cb1-97"><a href="#cb1-97"></a></span>
<span id="cb1-98"><a href="#cb1-98"></a>  <span class="kw">fn</span> initial_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-99"><a href="#cb1-99"></a>    <span class="kw">match</span> (<span class="kw">self</span><span class="op">.</span><span class="dv">0</span><span class="op">.</span>initial_state()<span class="op">,</span> <span class="kw">self</span><span class="op">.</span><span class="dv">1</span><span class="op">.</span>initial_state()) <span class="op">{</span></span>
<span id="cb1-100"><a href="#cb1-100"></a>      (<span class="cn">Some</span>(st0)<span class="op">,</span> <span class="cn">Some</span>(st1)) <span class="op">=&gt;</span> <span class="cn">Some</span>((st0<span class="op">,</span> st1))<span class="op">,</span></span>
<span id="cb1-101"><a href="#cb1-101"></a>      _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-102"><a href="#cb1-102"></a>    <span class="op">}</span></span>
<span id="cb1-103"><a href="#cb1-103"></a>  <span class="op">}</span></span>
<span id="cb1-104"><a href="#cb1-104"></a></span>
<span id="cb1-105"><a href="#cb1-105"></a>  <span class="kw">fn</span> next_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">,</span> c<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Char) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-106"><a href="#cb1-106"></a>    <span class="kw">match</span> (</span>
<span id="cb1-107"><a href="#cb1-107"></a>      <span class="kw">self</span><span class="op">.</span><span class="dv">0</span><span class="op">.</span>next_state(<span class="op">&amp;</span>state<span class="op">.</span><span class="dv">0</span><span class="op">,</span> c)<span class="op">,</span></span>
<span id="cb1-108"><a href="#cb1-108"></a>      <span class="kw">self</span><span class="op">.</span><span class="dv">1</span><span class="op">.</span>next_state(<span class="op">&amp;</span>state<span class="op">.</span><span class="dv">1</span><span class="op">,</span> c)<span class="op">,</span></span>
<span id="cb1-109"><a href="#cb1-109"></a>    ) <span class="op">{</span></span>
<span id="cb1-110"><a href="#cb1-110"></a>      (<span class="cn">Some</span>(st0)<span class="op">,</span> <span class="cn">Some</span>(st1)) <span class="op">=&gt;</span> <span class="cn">Some</span>((st0<span class="op">,</span> st1))<span class="op">,</span></span>
<span id="cb1-111"><a href="#cb1-111"></a>      _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-112"><a href="#cb1-112"></a>    <span class="op">}</span></span>
<span id="cb1-113"><a href="#cb1-113"></a>  <span class="op">}</span></span>
<span id="cb1-114"><a href="#cb1-114"></a></span>
<span id="cb1-115"><a href="#cb1-115"></a>  <span class="kw">fn</span> is_accept_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-116"><a href="#cb1-116"></a>    <span class="kw">self</span><span class="op">.</span><span class="dv">0</span><span class="op">.</span>is_accept_state(<span class="op">&amp;</span>state<span class="op">.</span><span class="dv">0</span>) <span class="op">&amp;&amp;</span> <span class="kw">self</span><span class="op">.</span><span class="dv">1</span><span class="op">.</span>is_accept_state(<span class="op">&amp;</span>state<span class="op">.</span><span class="dv">1</span>)</span>
<span id="cb1-117"><a href="#cb1-117"></a>  <span class="op">}</span></span>
<span id="cb1-118"><a href="#cb1-118"></a><span class="op">}</span></span>
<span id="cb1-119"><a href="#cb1-119"></a></span>
<span id="cb1-120"><a href="#cb1-120"></a><span class="co">// ある整数以下のみ受理する DFA</span></span>
<span id="cb1-121"><a href="#cb1-121"></a><span class="kw">struct</span> Le<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span>(<span class="op">&amp;</span><span class="ot">&#39;a</span> [<span class="dt">u8</span>])<span class="op">;</span></span>
<span id="cb1-122"><a href="#cb1-122"></a></span>
<span id="cb1-123"><a href="#cb1-123"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="bu">Hash</span><span class="at">)]</span></span>
<span id="cb1-124"><a href="#cb1-124"></a><span class="kw">struct</span> LeState <span class="op">{</span></span>
<span id="cb1-125"><a href="#cb1-125"></a>  i<span class="op">:</span> <span class="dt">usize</span><span class="op">,</span></span>
<span id="cb1-126"><a href="#cb1-126"></a>  tight<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb1-127"><a href="#cb1-127"></a><span class="op">}</span></span>
<span id="cb1-128"><a href="#cb1-128"></a></span>
<span id="cb1-129"><a href="#cb1-129"></a><span class="kw">impl</span> Dfa <span class="kw">for</span> Le<span class="op">&lt;</span><span class="ot">&#39;_</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-130"><a href="#cb1-130"></a>  <span class="kw">type</span> Char <span class="op">=</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb1-131"><a href="#cb1-131"></a>  <span class="kw">type</span> State <span class="op">=</span> LeState<span class="op">;</span></span>
<span id="cb1-132"><a href="#cb1-132"></a></span>
<span id="cb1-133"><a href="#cb1-133"></a>  <span class="kw">fn</span> initial_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-134"><a href="#cb1-134"></a>    <span class="cn">Some</span>(LeState <span class="op">{</span> i<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> tight<span class="op">:</span> <span class="cn">true</span> <span class="op">}</span>)</span>
<span id="cb1-135"><a href="#cb1-135"></a>  <span class="op">}</span></span>
<span id="cb1-136"><a href="#cb1-136"></a></span>
<span id="cb1-137"><a href="#cb1-137"></a>  <span class="kw">fn</span> next_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">,</span> c<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Char) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-138"><a href="#cb1-138"></a>    (<span class="kw">self</span><span class="op">.</span><span class="dv">0</span><span class="op">.</span>get(state<span class="op">.</span>i))</span>
<span id="cb1-139"><a href="#cb1-139"></a>      <span class="op">.</span>and_then(<span class="op">|</span>upper<span class="op">|</span> <span class="kw">match</span> (state<span class="op">.</span>tight<span class="op">,</span> c<span class="op">.</span>cmp(upper)) <span class="op">{</span></span>
<span id="cb1-140"><a href="#cb1-140"></a>        (<span class="cn">false</span><span class="op">,</span> _) <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="cn">false</span>)<span class="op">,</span></span>
<span id="cb1-141"><a href="#cb1-141"></a>        (<span class="cn">true</span><span class="op">,</span> Less) <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="cn">false</span>)<span class="op">,</span></span>
<span id="cb1-142"><a href="#cb1-142"></a>        (<span class="cn">true</span><span class="op">,</span> Equal) <span class="op">=&gt;</span> <span class="cn">Some</span>(<span class="cn">true</span>)<span class="op">,</span></span>
<span id="cb1-143"><a href="#cb1-143"></a>        (<span class="cn">true</span><span class="op">,</span> Greater) <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-144"><a href="#cb1-144"></a>      <span class="op">}</span>)</span>
<span id="cb1-145"><a href="#cb1-145"></a>      <span class="op">.</span>map(<span class="op">|</span>tight<span class="op">|</span> LeState <span class="op">{</span></span>
<span id="cb1-146"><a href="#cb1-146"></a>        i<span class="op">:</span> state<span class="op">.</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb1-147"><a href="#cb1-147"></a>        tight<span class="op">,</span></span>
<span id="cb1-148"><a href="#cb1-148"></a>      <span class="op">}</span>)</span>
<span id="cb1-149"><a href="#cb1-149"></a>  <span class="op">}</span></span>
<span id="cb1-150"><a href="#cb1-150"></a></span>
<span id="cb1-151"><a href="#cb1-151"></a>  <span class="kw">fn</span> is_accept_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> _<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-152"><a href="#cb1-152"></a>    <span class="cn">true</span></span>
<span id="cb1-153"><a href="#cb1-153"></a>  <span class="op">}</span></span>
<span id="cb1-154"><a href="#cb1-154"></a><span class="op">}</span></span>
<span id="cb1-155"><a href="#cb1-155"></a></span>
<span id="cb1-156"><a href="#cb1-156"></a><span class="co">// ある整数の倍数のみ受理する DFA</span></span>
<span id="cb1-157"><a href="#cb1-157"></a><span class="kw">struct</span> MultipleOf(<span class="dt">u64</span>)<span class="op">;</span></span>
<span id="cb1-158"><a href="#cb1-158"></a></span>
<span id="cb1-159"><a href="#cb1-159"></a><span class="kw">impl</span> Dfa <span class="kw">for</span> MultipleOf <span class="op">{</span></span>
<span id="cb1-160"><a href="#cb1-160"></a>  <span class="kw">type</span> Char <span class="op">=</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb1-161"><a href="#cb1-161"></a>  <span class="kw">type</span> State <span class="op">=</span> <span class="dt">u64</span><span class="op">;</span></span>
<span id="cb1-162"><a href="#cb1-162"></a></span>
<span id="cb1-163"><a href="#cb1-163"></a>  <span class="kw">fn</span> initial_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-164"><a href="#cb1-164"></a>    <span class="cn">Some</span>(<span class="dv">0</span>)</span>
<span id="cb1-165"><a href="#cb1-165"></a>  <span class="op">}</span></span>
<span id="cb1-166"><a href="#cb1-166"></a></span>
<span id="cb1-167"><a href="#cb1-167"></a>  <span class="kw">fn</span> next_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">,</span> c<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Char) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-168"><a href="#cb1-168"></a>    <span class="cn">Some</span>((<span class="dv">10</span> <span class="op">*</span> <span class="op">*</span>state <span class="op">+</span> <span class="dt">u64</span><span class="pp">::</span>from(<span class="op">*</span>c)) <span class="op">%</span> <span class="kw">self</span><span class="op">.</span><span class="dv">0</span>)</span>
<span id="cb1-169"><a href="#cb1-169"></a>  <span class="op">}</span></span>
<span id="cb1-170"><a href="#cb1-170"></a></span>
<span id="cb1-171"><a href="#cb1-171"></a>  <span class="kw">fn</span> is_accept_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-172"><a href="#cb1-172"></a>    <span class="op">*</span>state <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb1-173"><a href="#cb1-173"></a>  <span class="op">}</span></span>
<span id="cb1-174"><a href="#cb1-174"></a><span class="op">}</span></span>
<span id="cb1-175"><a href="#cb1-175"></a></span>
<span id="cb1-176"><a href="#cb1-176"></a><span class="co">// ジグザグ数のみ受理する DFA</span></span>
<span id="cb1-177"><a href="#cb1-177"></a><span class="kw">struct</span> ZigZag<span class="op">;</span></span>
<span id="cb1-178"><a href="#cb1-178"></a></span>
<span id="cb1-179"><a href="#cb1-179"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="bu">Hash</span><span class="at">)]</span></span>
<span id="cb1-180"><a href="#cb1-180"></a><span class="kw">enum</span> ZigZagState <span class="op">{</span></span>
<span id="cb1-181"><a href="#cb1-181"></a>  Empty<span class="op">,</span></span>
<span id="cb1-182"><a href="#cb1-182"></a>  Single(<span class="dt">u8</span>)<span class="op">,</span></span>
<span id="cb1-183"><a href="#cb1-183"></a>  Increasing(<span class="dt">u8</span>)<span class="op">,</span></span>
<span id="cb1-184"><a href="#cb1-184"></a>  Decreasing(<span class="dt">u8</span>)<span class="op">,</span></span>
<span id="cb1-185"><a href="#cb1-185"></a><span class="op">}</span></span>
<span id="cb1-186"><a href="#cb1-186"></a></span>
<span id="cb1-187"><a href="#cb1-187"></a><span class="kw">impl</span> Dfa <span class="kw">for</span> ZigZag <span class="op">{</span></span>
<span id="cb1-188"><a href="#cb1-188"></a>  <span class="kw">type</span> Char <span class="op">=</span> <span class="dt">u8</span><span class="op">;</span></span>
<span id="cb1-189"><a href="#cb1-189"></a>  <span class="kw">type</span> State <span class="op">=</span> ZigZagState<span class="op">;</span></span>
<span id="cb1-190"><a href="#cb1-190"></a></span>
<span id="cb1-191"><a href="#cb1-191"></a>  <span class="kw">fn</span> initial_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-192"><a href="#cb1-192"></a>    <span class="cn">Some</span>(<span class="pp">ZigZagState::</span>Empty)</span>
<span id="cb1-193"><a href="#cb1-193"></a>  <span class="op">}</span></span>
<span id="cb1-194"><a href="#cb1-194"></a></span>
<span id="cb1-195"><a href="#cb1-195"></a>  <span class="kw">fn</span> next_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">,</span> c<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>Char) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Self</span><span class="pp">::</span>State<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-196"><a href="#cb1-196"></a>    <span class="kw">use</span> <span class="pp">ZigZagState::</span><span class="op">*;</span></span>
<span id="cb1-197"><a href="#cb1-197"></a></span>
<span id="cb1-198"><a href="#cb1-198"></a>    <span class="kw">match</span> state <span class="op">{</span></span>
<span id="cb1-199"><a href="#cb1-199"></a>      Empty <span class="op">=&gt;</span> <span class="kw">match</span> <span class="op">*</span>c <span class="op">{</span></span>
<span id="cb1-200"><a href="#cb1-200"></a>        <span class="dv">0</span> <span class="op">=&gt;</span> <span class="cn">Some</span>(Empty)<span class="op">,</span></span>
<span id="cb1-201"><a href="#cb1-201"></a>        _ <span class="op">=&gt;</span> <span class="cn">Some</span>(Single(<span class="op">*</span>c))<span class="op">,</span></span>
<span id="cb1-202"><a href="#cb1-202"></a>      <span class="op">},</span></span>
<span id="cb1-203"><a href="#cb1-203"></a>      Single(c_prev) <span class="op">=&gt;</span> <span class="kw">match</span> c_prev<span class="op">.</span>cmp(c) <span class="op">{</span></span>
<span id="cb1-204"><a href="#cb1-204"></a>        Less <span class="op">=&gt;</span> <span class="cn">Some</span>(Increasing(<span class="op">*</span>c))<span class="op">,</span></span>
<span id="cb1-205"><a href="#cb1-205"></a>        Equal <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-206"><a href="#cb1-206"></a>        Greater <span class="op">=&gt;</span> <span class="cn">Some</span>(Decreasing(<span class="op">*</span>c))<span class="op">,</span></span>
<span id="cb1-207"><a href="#cb1-207"></a>      <span class="op">},</span></span>
<span id="cb1-208"><a href="#cb1-208"></a>      Increasing(c_prev) <span class="op">=&gt;</span> <span class="kw">match</span> c_prev<span class="op">.</span>cmp(c) <span class="op">{</span></span>
<span id="cb1-209"><a href="#cb1-209"></a>        Less <span class="op">|</span> Equal <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-210"><a href="#cb1-210"></a>        Greater <span class="op">=&gt;</span> <span class="cn">Some</span>(Decreasing(<span class="op">*</span>c))<span class="op">,</span></span>
<span id="cb1-211"><a href="#cb1-211"></a>      <span class="op">},</span></span>
<span id="cb1-212"><a href="#cb1-212"></a>      Decreasing(c_prev) <span class="op">=&gt;</span> <span class="kw">match</span> c_prev<span class="op">.</span>cmp(c) <span class="op">{</span></span>
<span id="cb1-213"><a href="#cb1-213"></a>        Less <span class="op">=&gt;</span> <span class="cn">Some</span>(Increasing(<span class="op">*</span>c))<span class="op">,</span></span>
<span id="cb1-214"><a href="#cb1-214"></a>        Equal <span class="op">|</span> Greater <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb1-215"><a href="#cb1-215"></a>      <span class="op">},</span></span>
<span id="cb1-216"><a href="#cb1-216"></a>    <span class="op">}</span></span>
<span id="cb1-217"><a href="#cb1-217"></a>  <span class="op">}</span></span>
<span id="cb1-218"><a href="#cb1-218"></a></span>
<span id="cb1-219"><a href="#cb1-219"></a>  <span class="kw">fn</span> is_accept_state(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> state<span class="op">:</span> <span class="op">&amp;</span><span class="dt">Self</span><span class="pp">::</span>State) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb1-220"><a href="#cb1-220"></a>    <span class="op">!</span><span class="pp">matches!</span>(state<span class="op">,</span> <span class="pp">ZigZagState::</span>Empty)</span>
<span id="cb1-221"><a href="#cb1-221"></a>  <span class="op">}</span></span>
<span id="cb1-222"><a href="#cb1-222"></a><span class="op">}</span></span>
<span id="cb1-223"><a href="#cb1-223"></a></span>
<span id="cb1-224"><a href="#cb1-224"></a><span class="kw">fn</span> solve(x<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]<span class="op">,</span> m<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">u64</span> <span class="op">{</span></span>
<span id="cb1-225"><a href="#cb1-225"></a>  <span class="kw">let</span> (ModSum(ans)<span class="op">,</span> _) <span class="op">=</span> automaton_dp(</span>
<span id="cb1-226"><a href="#cb1-226"></a>    And(And(Le(<span class="op">&amp;</span>x)<span class="op">,</span> MultipleOf(m))<span class="op">,</span> ZigZag)<span class="op">,</span></span>
<span id="cb1-227"><a href="#cb1-227"></a>    <span class="dv">0</span><span class="op">..=</span><span class="dv">9</span><span class="op">,</span></span>
<span id="cb1-228"><a href="#cb1-228"></a>    x<span class="op">.</span>len()<span class="op">,</span></span>
<span id="cb1-229"><a href="#cb1-229"></a>    <span class="op">|&amp;</span>(ModSum(x)<span class="op">,</span> ModSum(n))<span class="op">,</span> <span class="op">&amp;</span>c<span class="op">|</span> (ModSum((<span class="dv">10</span> <span class="op">*</span> x <span class="op">+</span> <span class="dt">u64</span><span class="pp">::</span>from(c) <span class="op">*</span> n) <span class="op">%</span> MOD)<span class="op">,</span> ModSum(n))<span class="op">,</span></span>
<span id="cb1-230"><a href="#cb1-230"></a>    (ModSum(<span class="dv">0</span>)<span class="op">,</span> ModSum(<span class="dv">1</span>))<span class="op">,</span></span>
<span id="cb1-231"><a href="#cb1-231"></a>  )<span class="op">;</span></span>
<span id="cb1-232"><a href="#cb1-232"></a>  ans</span>
<span id="cb1-233"><a href="#cb1-233"></a><span class="op">}</span></span></code></pre></div>
<p>この問題特有の部分 (ジグザグ数を受理する DFA) が，その他の汎用的な部分から分離されていることが分かると思います．この汎用的な部分をライブラリにしておけば，実際に問題を解くときにはその問題特有の DFA を実装するだけでよいことになり，煩雑になりがちな桁 DP の実装を回避することができます．</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/spaghetti-source/algorithm/blob/4fdac8202e26def25c1baf9127aaaed6a2c9f7c7/dynamic_programming/digit_dp.cc">algorithm/digit_dp.cc at master · spaghetti-source/algorithm</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><span class="math inline">\(\langle M, \oplus \rangle\)</span> の単位元という意味ではないので注意してください．<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><span class="math inline">\(\lbrack n \rbrack\)</span> との直積を取ったことによって状態数が <span class="math inline">\(n + 1\)</span> 倍され，計算量のオーダーが悪化しそうに見えるかもしれませんが，これは簡単な枝刈りによって回避することができます．詳しくは実装を参照してください．<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>区間加算更新+区間和取得の遅延伝播セグメント木などを参照するとよいです．<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
        </div>
      </article>
      <footer id="global-footer">
        <div id="global-footer-container">
          <small class="copyright">&copy; 2020 kuretchi</small>
        </div>
      </footer>
    </div>
  </body>
</html>
